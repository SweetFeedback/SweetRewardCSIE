<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>SweetFeedback in CSIE building</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="">
        <meta name="author" content="">

        <!-- Le styles -->
        <link href="assets/css/bootstrap.css" rel="stylesheet">
        <link href="assets/css/style.css" rel="stylesheet">

        <!--<link href="assets/css/docs.css" rel="stylesheet">-->
        <link href="assets/css/bootstrap-responsive.css" rel="stylesheet">

        <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
        <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->

        <!-- Le fav and touch icons -->
        <link rel="shortcut icon" href="assets/ico/favicon.png">
    </head>

    <body>
        <div class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="./index.html"><img src="img/logo.png" width="24px" id="logo"/>SweetFeedback</a>
                    <div class="nav-collapse">
                        <ul class="nav">
                            <li class="active"><a href="#">Home</a></li>
                            <li><a href="#about">About</a></li>
                        </ul>
                        <ul class="nav pull-right">
                            <li class="dropdown" id="login">
                            <a class="dropdown-toggle" data-toggle="dropdown" href="#login">Login<b class="caret"></b></a>

                            <div class="dropdown-menu">
                                <form>
                                    <fieldset class='textbox' style="padding:10px">
                                        <input id="account" style="margin-top: 8px" type="text" placeholder="Account" name="account"/>
                                        <input id="password" style="margin-top: 8px" type="password" placeholder="Passsword" name="password"/>
                                        <a class="btn btn-primary" id="loginBt">Log In</a>
                                        <a data-toggle="modal" href="#reg" class="btn btn-primary" id="registerBt" >Register</a>
                                    </fieldset>
                                </form>
                            </div>
                            </li>

                            <li id="setting" class="dropdown">
                            <a href="#" id="current_user" role="button" class="dropdown-toggle" data-toggle="dropdown"></a>
                            <ul class="dropdown-menu" role="menu" aria-labelledby="drop3">
                                <li><a tabindex="-1" href="./settings.html">Settings</a></li>
                                <li class="divider"></li>
                                <li><a tabindex="-1" href="#" id="logoutBt">Log Out</a></li>
                            </ul>
                            </li>

                        </ul>
                    </div><!--/.nav-collapse -->
                </div>
            </div>
        </div>

        <div class="container">
            
            <div id="reg" class="modal hide fade">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h3>Register a new account!</h3>
                </div>
                <div class="modal-body">
                    <form>
                        <input id="reg_account" style="margin-top: 8px" type="text" placeholder="Enter your Account here" name="reg_account"/><br>
                        <input id="reg_password" style="margin-top: 8px" type="password" placeholder="Enter your Passsword here" name="reg_password"/>
                    </form>
                </div>
                <div class="modal-footer">
                    <a class="btn btn-primary" id="registerSubmit" data-dismiss="modal">Register</a>
                    <a href="#" class="btn" data-dismiss="modal" >Close</a>
                </div>
            </div>
            <div class="tabable">
                <ul class="nav nav-pills spliter">
                    <li class="active">
                    <a href="#apps-1" data-toggle="tab" id="app1">CSIE Building</a>
                    </li>
                </ul>

                <div class="tab-content">
                    <div class="tab-pane active" id="apps-1">
                        <div id="user_preference">User Preference: 
                            <span id="light_preference"></span>, 
                            <span id="temp_preference"></span>, 
                            <span id="sound_preference"></span>
                        </div>          
                        <!--<div id="testTxt">cc</div> -->                                                    
                        <div id="left">
                            <!-- map -->
                            <div id="map"><img id="map_2f" src="img/csie/csie_map.png"/></div>
                            
                            <!-- windows -->
                            <div id="win_1" class="win"></div>
                            <div id="win_2" class="win"></div>
                            <div id="win_3" class="win"></div>
                            <div id="win_4" class="win"></div>
                            <div id="win_5" class="win"></div>
                            <div id="win_6" class="win"></div>
                            <div id="win_7" class="win"></div>

                            <!-- rooms -->
                            <div id="room_1" data-toggle="modal" href="#room_1_detail"></div> <!--r336_r338 -->
                            <div id="room_1_detail" class="modal hide fade">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                                    <h3>R336/R338</h3>
                                </div>
                                <div class="modal-body">
                                </div>
                                <div class="modal-footer">
                                    <a href="#" class="btn" data-dismiss="modal" >Close</a>
                                </div>
                            </div>
                            <div id="room_2" data-toggle="modal" href="#room_2_detail"></div> <!--r306_r308 -->
                            <div id="room_2_detail" class="modal hide fade">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                                    <h3>R306/R308</h3>
                                </div>
                                <div class="modal-body">
                                </div>
                                <div class="modal-footer">
                                    <a href="#" class="btn" data-dismiss="modal" >Close</a>
                                </div>
                            </div>
                            <div id="room_3" data-toggle="modal" href="#room_3_detail"></div> <!--r302_r304 -->
                            <div id="room_3_detail" class="modal hide fade">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                                    <h3>R302/R304</h3>
                                </div>
                                <div class="modal-body">
                                </div>
                                <div class="modal-footer">
                                    <a href="#" class="btn" data-dismiss="modal" >Close</a>
                                </div>
                            </div>
                            <div id="room_4" data-toggle="modal" href="#room_4_detail"></div> <!--r310 -->
                            <div id="room_4_detail" class="modal hide fade">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                                    <h3>R310</h3>
                                </div>
                                <div class="modal-body">
                                </div>
                                <div class="modal-footer">
                                    <a href="#" class="btn" data-dismiss="modal" >Close</a>
                                </div>
                            </div>
                            <div id="room_5" data-toggle="modal" href="#room_5_detail"></div> <!--r324 -->
                            <div id="room_5_detail" class="modal hide fade">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                                    <h3>R324</h3>
                                </div>
                                <div class="modal-body">
                                    <div>Motion(People)</div>
                                    <div>Sound</div>
                                    <div>Humidity</div>
                                    <div>Temperature</div>
                                    <div>Light</div>
                                </div>
                                <div class="modal-footer">
                                    <a href="#" class="btn" data-dismiss="modal" >Close</a>
                                </div>
                            </div> 
                            <div id="room_6" data-toggle="modal" href="#room_6_detail"></div> <!--r318 -->
                            <div id="room_6_detail" class="modal hide fade">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                                    <h3>R318</h3>
                                </div>
                                <div class="modal-body">
                                </div>
                                <div class="modal-footer">
                                    <a href="#" class="btn" data-dismiss="modal" >Close</a>
                                </div>
                            </div>

                            <div id="info" >
                                <li><img src="img/others/char-cold.png"/> : Cold </li>
                                <li><img class="sweat" src="img/others/char-sweat.png"/> : Hot </li>
                                <li><img src="img/others/char-headphone.png"/> : Noisy </li>
                                <li><img src="img/others/char-sunglass.png"/> : Bright </li>
                            </div>

                        </div>
                        <div id="right">
                            <a data-toggle="modal" href="#report" class="btn btn-primary" style="margin-bottom: 5px;">Report a Problem!</a>
                            <div class="bs-docs-example">
                                <ul id="myTab" class="nav nav-tabs" style="margin: 0px; padding: 0px;">
                                    <li class="active"><a href="#feedbackHistory" data-toggle="tab">Feedback History</a></li>
                                    <li><a href="#problemArea" data-toggle="tab">Problem List</a></li>
                                </ul>

                                <div id="myTabContent" class="tab-content" style="backgkround-color: #ffffff; margin: 0px; padding: 0px;">
                                    <div class="tab-pane fade in active tabStyle" id="feedbackHistory">
                                    </div>

                                    <div class="tab-pane fade tabStyle" id="problemArea">

                                    </div>
                                </div>
                            </div>

                            <div id="report" class="modal hide fade">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                                    <h3>Report a Problem!</h3>
                                </div>
                                <div class="modal-body">
                                    <div id="problem_select" class="btn-group">
                                        <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                                            <span id="problem_title">Any Problem?</span>
                                            <span class="caret"></span>
                                            <input type="hidden" id="problem_id" />
                                        </a>
                                        <ul class="dropdown-menu">
                                            <li>
                                                <a href="#" id="hot">Hot Problem</a>
                                            </li>
                                            <li>
                                                <a href="#" id="cold">Cold Problem</a>
                                            </li>
                                            <li>
                                                <a href="#" id="noise">Noisy Problem</a>
                                            </li>
                                            <li>
                                                <a href="#" id="other">Other Problem</a>
                                            </li>
                                        </ul>
                                    </div>
                                    <div id="location_select" class="btn-group">
                                        <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                                            <span id="location_title">Choose Location..</span>
                                            <span class="caret"></span>
                                            <input type="hidden" id="location_id" />
                                        </a>
                                        <ul class="dropdown-menu">
                                            <li>
                                                <a href="#" id="1" class="room">R336/R338</a>
                                            </li>
                                            <li>
                                                <a href="#" id="2" class="room">R306/R308</a>
                                            </li>
                                            <li>
                                                <a href="#" id="3" class="room">R302/R304</a>
                                            </li>
                                            <li>
                                                <a href="#" id="4" class="room">R310</a>
                                            </li>
                                            <li>
                                                <a href="#" id="5" class="room">R324</a>
                                            </li>
                                            <li>
                                                <a href="#" id="6" class="room">R318</a>
                                            </li>
                                        </ul>
                                    </div>
                                    
                                    <form id="problemInputForm">
                                        <fieldset class='textbox'>
                                            <textarea id="problemInput" style="margin-top: 8px; width: 90%; height:180px;">problem.... </textarea>
                                        </fieldset>

                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <a class="btn btn-primary" id="reportSubmit" data-dismiss="modal">Submit</a>
                                    <a href="#" class="btn" data-dismiss="modal" >Close</a>
                                </div>
                            </div>
                            
                        </div>

                        <div class="machine" id="mrc_1">
                            <img class="mrc" src="img/mrc/mrc.png" width="50px"/>
                            <img class="cold" src="img/others/char-cold.png" width="65px" style="margin-top: -155px; margin-left: -3px;"/>
                            <img class="sunglass" src="img/others/char-sunglass.png" width="65px" style="margin-top: -132px; margin-left: -6px;"/>
                            <img class="headphone" src="img/others/char-headphone.png" width="65px" style="margin-top: -200px; margin-left: -6px;"/>
                            <img class="sweat" src="img/others/char-sweat.png" width="65px" style="margin-top: -200px; margin-left: -6px;"/>
                            <img class="transportation" src="img/transportation/empty.png" width="30px" style="margin-top: -120px; margin-left: -10px;"/>
                            <div class="mrc_num" >1</div>
                        </div>

                        <div class="machine" id="mrc_2">
                            <img class="mrc" src="img/mrc/mrc.png" width="50px"/>
                            <img class="cold" src="img/others/char-cold.png" width="65px" style="margin-top: -155px; margin-left: -3px;"/>
                            <img class="sunglass" src="img/others/char-sunglass.png" width="65px" style="margin-top: -132px; margin-left: -6px;"/>
                            <img class="headphone" src="img/others/char-headphone.png" width="65px" style="margin-top: -200px; margin-left: -6px;"/>
                            <img class="sweat" src="img/others/char-sweat.png" width="65px" style="margin-top: -200px; margin-left: -6px;"/>
                            <img class="transportation" src="img/transportation/empty.png" width="30px" style="margin-top: -120px; margin-left: -10px;"/>
                            <div class="mrc_num" >2</div>
                        </div>

                        <div class="machine" id="mrc_3">
                            <img class="mrc" src="img/mrc/mrc.png" width="50px"/>
                            <img class="cold" src="img/others/char-cold.png" width="65px" style="margin-top: -155px; margin-left: -3px;"/>
                            <img class="sunglass" src="img/others/char-sunglass.png" width="65px" style="margin-top: -132px; margin-left: -6px;"/>
                            <img class="headphone" src="img/others/char-headphone.png" width="65px" style="margin-top: -200px; margin-left: -6px;"/>
                            <img class="sweat" src="img/others/char-sweat.png" width="65px" style="margin-top: -200px; margin-left: -6px;"/>
                            <img class="transportation" src="img/transportation/empty.png" width="30px" style="margin-top: -120px; margin-left: -10px;"/>
                            <div class="mrc_num" >3</div>
                        </div>

                        <!--<div class="machine" id="mrc_4">
                            <img class="mrc" src="img/mrc/mrc.png" width="50px"/>
                            <img class="cold" src="img/others/char-cold.png" width="65px" style="margin-top: -155px; margin-left: -3px;"/>
                            <img class="sunglass" src="img/others/char-sunglass.png" width="65px" style="margin-top: -132px; margin-left: -6px;"/>
                            <img class="headphone" src="img/others/char-headphone.png" width="65px" style="margin-top: -200px; margin-left: -6px;"/>
                            <img class="sweat" src="img/others/char-sweat.png" width="65px" style="margin-top: -200px; margin-left: -6px;"/>
                            <img class="transportation" src="img/transportation/empty.png" width="30px" style="margin-top: -120px; margin-left: -10px;"/>
                            <div class="mrc_num" >4</div>
                        </div>

                        <div class="machine" id="mrc_5">
                            <img class="mrc" src="img/mrc/mrc.png" width="50px"/>
                            <img class="cold" src="img/others/char-cold.png" width="65px" style="margin-top: -155px; margin-left: -3px;"/>
                            <img class="sunglass" src="img/others/char-sunglass.png" width="65px" style="margin-top: -132px; margin-left: -6px;"/>
                            <img class="headphone" src="img/others/char-headphone.png" width="65px" style="margin-top: -200px; margin-left: -6px;"/>
                            <img class="sweat" src="img/others/char-sweat.png" width="65px" style="margin-top: -200px; margin-left: -6px;"/>
                            <img class="transportation" src="img/transportation/empty.png" width="30px" style="margin-top: -120px; margin-left: -10px;"/>
                            <div class="mrc_num" >5</div>
                        </div>-->
                        <br/>
                        

                    </div>
                </div>
            </div>
            
           

        </div> <!-- /container -->

        <!-- Le javascript
        ================================================== -->
        <!-- Placed at the end of the document so the pages load faster -->
        <script src="assets/js/jquery.js"></script>
        <script src="assets/js/bootstrap-transition.js"></script>
        <script src="assets/js/bootstrap-alert.js"></script>
        <script src="assets/js/bootstrap-modal.js"></script>
        <script src="assets/js/bootstrap-dropdown.js"></script>
        <script src="assets/js/bootstrap-scrollspy.js"></script>
        <script src="assets/js/bootstrap-tab.js"></script>
        <script src="assets/js/bootstrap-tooltip.js"></script>
        <script src="assets/js/bootstrap-popover.js"></script>
        <script src="assets/js/bootstrap-button.js"></script>
        <script src="assets/js/bootstrap-collapse.js"></script>
        <script src="assets/js/bootstrap-carousel.js"></script>
        <script src="assets/js/bootstrap-typeahead.js"></script>
        <!--<script src="assets/js/jquery.cookie.js"></script>-->

        <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyA3ieESIwbYV6OZC14fivVKoOSYvApTlh0&sensor=true&libraries=geometry"></script>
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/jquery-ui.min.js"></script>



        <script language="javascript">
            //open & close win
                function win_open(w_id, degree) {
        
                    $("#win_"+w_id).css({ WebkitTransform: 'rotate(' + degree + 'deg)'});  
                    $("#win_"+w_id).css({ '-moz-transform': 'rotate(' + degree + 'deg)'});                      
                    setTimeout(function() {
                        ++degree; 
                        if(degree>=30){
                            degree = 0;
                        }else{
                            win_open(w_id, degree);                
                        }
            
                    },5);
                }
                function win_close(w_id, degree) {
        
                    $("#win_"+w_id).css({ WebkitTransform: 'rotate(' + degree + 'deg)'});  
                    $("#win_"+w_id).css({ '-moz-transform': 'rotate(' + degree + 'deg)'});                      
                    setTimeout(function() {
                        --degree; 
                        if(degree<=0){
                            degree = 0;
                        }else{
                            win_close(w_id, degree);                
                        }
                    },5);
                }

            function getUserPreference(){
                /* get profile preference */

                $.ajax({
                    type: "GET",
                    url: "./php/mobile/getUserPreference.php",
                    data: { 
                        "token": window.cur_token
                    },
                    dataType: 'json',
                    success: function(data) {
                        if(data['success'] == 1){
                            window.light_threshold = parseInt(data['data']['light_threshold']); 
                            window.temperature_threshold = parseInt(data['data']['temperature_threshold']);
                            window.micro_threshold = parseInt(data['data']['micro_threshold']);

                            $('#light_preference').text(window.light_threshold);
                            $('#temp_preference').text(window.temperature_threshold);
                            $('#sound_preference').text(window.micro_threshold);
                            $('#user_preference').show();
                        }
                    },
                    error: function(XMLHttpRequest, textStatus, errorThrown) {}
                });
            }
            function updateMachineStatus(){
                
                
                /* get sensor value*/
                $.ajax({
                    type: "GET",
                    url: "./php/getSensorValuesNew.php",

                    dataType: 'json',
                    success: function(data) {
                        
                        $('#mrc_1').addClass('offline');
                        $('#mrc_2').addClass('offline');
                        $('#mrc_3').addClass('offline');
                        //$('#mrc_4').addClass('offline');
                        //$('#mrc_5').addClass('offline');

                        $.each(data['data'], function(i, item) {
                            var d_id = item['device_id'];

                            

                            // light 
                            if(parseFloat(item['light_level']) >= window.light_threshold){
                                $('#mrc_'+d_id+' img.sunglass').css("visibility", "visible");
                            }else{
                                $('#mrc_'+d_id+' img.sunglass').css("visibility", "hidden");
                            }


                            // temperature
                            if(parseFloat(item['temperature']) >= window.temperature_threshold+2){
                                $('#mrc_'+d_id+' img.sweat').css("visibility", "visible");
                                $('#mrc_'+d_id+' img.cold').css("visibility", "hidden");
                            }else{ 
                                if(parseFloat(item['temperature']) <= window.temperature_threshold-2){                                
                                    $('#mrc_'+d_id+' img.cold').css("visibility", "visible");
                                    $('#mrc_'+d_id+' img.sweat').css("visibility", "hidden");
                                }else{
                                    $('#mrc_'+d_id+' img.sweat').css("visibility", "hidden");
                                    $('#mrc_'+d_id+' img.cold').css("visibility", "hidden");
                                }
                            }



                            // sound_level
                            if(parseFloat(item['sound_level']) >= window.micro_threshold){
                                $('#mrc_'+d_id+' img.headphone').css("visibility", "visible");
                            }else{
                                $('#mrc_'+d_id+' img.headphone').css("visibility", "hidden");
                            }

                            

                            // window_state
                            if(parseInt(item['window_state']) == 1){
                                //$('#testTxt').text(d_id+"_yyy "+item['window_state']);
                                //$('#win_'+d_id).css("visibility", "visible");
                                
                                //window
                                //win_open(d_id, 0);
                                if(!$('#win_'+d_id).hasClass("open")){
                                    win_open(d_id, 0);
                                    $('#win_'+d_id).addClass("open");
                                }
                               
                            }else{
                                //$('#testTxt').text(d_id+"_nn "+ item['window_state']);
                                //$('#win_'+d_id).css("visibility", "hidden");
                                win_close(d_id, 0); 
                                if($('#win_'+d_id).hasClass("open")){
                                    win_close(d_id, 0);
                                    $('#win_'+d_id).removeClass("open");
                                }
                            }

                            
                            //show machine
                            //$('#mrc_'+d_id).show();
                            $('#mrc_'+d_id).removeClass("offline");

                        });
                    },
                    error: function(XMLHttpRequest, textStatus, errorThrown) {
                        //alert("get sensor Error");
                    }
                });

                
            }

            function milliSecondToMinutes(ret){
                var one_minutes = 1000*60;
                return Math.ceil(ret / one_minutes);
            }

            function checkLogin(){
                $.ajax({
                        type: "GET",
                        url: "./php/mobile/verifyUser.php",
                        dataType: 'json',
                        success: function(data) {
                            
                            if(data["is_logged_in"]==1){

                                window.cur_user = data["account"];
                                window.cur_token = data["token"];
                                window.cur_uid = data["user_id"]; 
                                $('#current_user').text("Hi, "+data["account"]+"! ");
                                $('#current_user').append('<b class="caret"></b>');
                    
                                $('#login').hide();
                                $('#setting').show();


                                getUserPreference();

                            }
                            else{
                                $('#login').show();
                                $('#setting').hide();

                            }
                        },
                        error: function(XMLHttpRequest, textStatus, errorThrown) {
                            //alert("Error");    
                        }
                    });
            }

            function readLocationData(){

            }




            function readProblemList(){
                $('.manual-toggle').toggle();
                /* clear problem list */
                $('#problemList').remove();
                $('#problemDetail').remove();
                $('#feedbackList').remove();

                var proList = $('<div></div>').attr('id','problemList');
                $('<ul></ul>').addClass('items').appendTo(proList);
                var proDetail = $('<div></div>').attr('id', 'problemDetail');
                
                var hisList = $('<div></div>').attr('id','feedbackList');
                $('<ul></ul>').addClass('items').appendTo(hisList);
                
                $('#problemArea').append(proList);
                $('#problemArea').append(proDetail);
                $('#feedbackHistory').append(hisList);

                /* get feedback history */
                $.ajax({
                    type: "GET",
                    url: "./php/getFeedbackHistory.php",
                    dataType: 'json',
                    success: function(data) {
                        
                        $.each(data, function(i, item) {
                            var historyList = $('<li><a href="#" class="tooltip-test" title="'+item.feedback_description+'">'+item.feedback_type+' ('+item.created_time+')</a></li>');

                            if(item.feedback_type == "positive"){
                                historyList.addClass('positive');
                            }else if(item.feedback_type == "negative"){
                                historyList.addClass('negative');
                            }else if(item.feedback_type == "sound"){
                                historyList.addClass('sound');
                            }

                            $('#feedbackList .items').append(historyList);
                        });

                        $('.tooltip-test').tooltip();
                        
                    },
                    error: function(XMLHttpRequest, textStatus, errorThrown) {
                        //alert("get exist Error");               
                    }
                });


                var problemMap = {};

                /* get existing report */
                $.ajax({
                    type: "GET",
                    url: "./php/getExistReports.php",
                    dataType: 'json',
                    success: function(data) {

                        $.each(data, function(i, item) {
                            $('#problemList .items').append('<li><a class="manual-toggle" data-toggle="modal" href="#problem_'+item.id+'">'+item.title+'</a></li>');

                            var problemDiv = $("<div></div>").attr('id','problem_'+item.id).addClass('modal hide fade');
                            var problemBody = $('<div></div>').addClass('modal-body').appendTo(problemDiv);

                            problemBody.append('<button type="button" class="close" data-dismiss="modal">&times;</button>');
                            problemBody.append("<h3>Problem: "+item.title+"</h3>");
                            problemBody.append('<span style="margin-left: 5px;">Create at '+item.created_at+'</span>');
                            problemDiv.append('<div class="modal-footer"><a href="#" class="btn fixIssue" id="problem_'+item.id+'"">Fixed it</a><a href="#" class="btn" data-dismiss="modal" >Close</a></div>');
                            problemDiv.appendTo('#problemDetail');

                            if(item.room in problemMap) problemMap[item.room]++;
                            else    problemMap[item.room] = 1;
                            
                        });
                        
                        $.each(problemMap, function(i, item){
                            if(i != 0){
                                $('#room_'+i).css({"background": "rgba(234,0,55,"+item/15.0+")"});
                            }
                        });


                        /* fix an existing report */
                        $('.fixIssue').click(function(){
                            var report = this.id.split('_');
                            $.ajax({
                                type: "GET",
                                url: "./php/makeFixReport.php",
                                data: { "user_id": window.cur_uid, "report_id": report[1] },

                                dataType: 'json',
                                success: function(data) {
                                    if(data.hasOwnProperty('success') && data['success'] == 1){
                                        $.post("./php/insertFeedback.php?application_id=10&type=positive"); /* fix a report and get feedback */
                                        readProblemList(); // update problem list
                                    }
                                    else if(data.hasOwnProperty('reconfirm') && data['reconfirm'] == 1){
                                        /// jump out a dialog to ask whether force or not
                                        var errorDiv = $("<div></div>").addClass("alert alert-error");
                                        errorDiv.text("what the fuck is this ?");
                                        errorDiv.appendTo($('#' + report[0]+'_'+report[1]));
                                        //$("#alert").show();
                                    }
                                },
                                error: function(XMLHttpRequest, textStatus, errorThrown) {
                                    //alert("fix report Error");
                                }
                            });
                        });
                    },
                    error: function(XMLHttpRequest, textStatus, errorThrown) {
                        //alert("get exist Error");               
                    }
                });
            }
            
            $(function(){
                //var degree = 0, timer;

                
                $('#user_preference').hide();

                /* hide headphone */
                //$('.machine').addClass('offline');
                $('.win').removeClass('open');
                //$('.win').css("visibility", "hidden");

                /* hide setting */
                $('#setting').hide();

                /* log in stuff */
                window.cur_user = "test";
                window.cur_token;
                window.cur_uid = 0;
                checkLogin();

                $('.dropdown-toggle').dropdown();
                $('#loginBt').click(function(){

                    $.ajax({

                        type: "GET",
                        url: "./php/mobile/verifyUser.php",
                        data: { "account": $('#account').val(), "password": $('#password').val() },
                        dataType: 'json',
                        success: function(data) {
                            
                            if(data["success"]==1){
                                
                                window.cur_user = data["account"];
                                window.cur_token = data["token"];
                                window.cur_uid = data["user_id"];
                                
                                $('#current_user').text("Hi, "+data["account"]+" !");
                                
                                $('#login').hide();
                                //$('#logoutBt').show();

                                $('#setting').show();

                            }else{
                                $('#login').show();
                                

                                $('#setting').hide();
                                //alert("No such user!");
                            }
                        },
                        error: function(XMLHttpRequest, textStatus, errorThrown) {
                            //alert("Error");    
                        }
                    });
                });
                $('#logoutBt').click(function(){

                    $.ajax({

                        type: "GET",
                        url: "./php/mobile/logout.php",
                        data: { },
                        dataType: 'json',
                        success: function(data) {
                            
                            if(data["success"]==1){
                                window.cur_user = 0;
                                window.cur_token = 0;
                                window.cur_uid = 0;

                                $('#current_user').text("");
                                 
                                $('#login').show();
                                $('#logoutBt').hide();

                            }else{
                                //alert("No such user!");
                            }
                        },
                        error: function(XMLHttpRequest, textStatus, errorThrown) {
                            //alert("Error");    
                        }
                    });
                });
                $('#registerSubmit').click(function(){
                    //alert($('#reg_account').val());
                    //alert($('#reg_password').val());
                    $.ajax({
                        type: "GET",
                        url: "./php/mobile/createNewUser.php",
                        data: { "account": $('#reg_account').val(), "password":$('#reg_password').val()},
                        dataType: 'json',
                        success: function(data){
                            alert("song la");
                        },
                        error: function(XMLHttpRequest, textStatus, errorThrown){
                        
                        }
                    });
                });


                //
                window.category = 0;
                $('#hot').click(function(){
                    window.category = 1;
                    $('#problem_title').text($('#hot').text());
                });
                $('#cold').click(function(){
                    window.category = 2;
                    $('#problem_title').text($('#cold').text());
                });
                $('#noise').click(function(){
                    $('#problem_title').text($('#noise').text());
                    window.category = 3;
                });
                $('#other').click(function(){
                    $('#problem_title').text($('#other').text());
                    window.category = 0;
                });


                /*$('#problem_select .dropdown-menu li a').on('click', function(){
                    $('#problem_title').text($(this).text());
                });*/

                //location
                $('#location_select .dropdown-menu li a').on('click', function(){
                    $('#location_title').text($(this).text());
                    $('#location_id').val(this.id);
                    
                });

                /* make a new report */
                $('#reportSubmit').click(function(){
                    $.ajax({
                        type: "GET",
                        url: "./php/makeNewReport.php",
                        data: { "user_id": window.cur_uid, "coordinate_x": "1", "coordinate_y": "1", "title": $('#problemInput').val(), 
                                "category": window.category, "room_id": $('#location_id').val()},

                        dataType: 'json',
                        success: function(data) {
                            $('#problemInput').val("");
                            readProblemList(); /* update problem list */
                            $.post("./php/insertFeedback.php?application_id=10&type=positive"); /* make new report and get feedback */
                        },
                        error: function(XMLHttpRequest, textStatus, errorThrown) {
                            //alert("make new Error");
                        }
                    });
                });


                /* read exist problems */
                readProblemList();

                /* make machine icon draggable */
                /*$(".machine").draggable({
                    cursor: 'move', 
                    containment: 'document'}
                );*/
                

                /* update machine status every 1 sec */
                setInterval(function(){
                    updateMachineStatus();
                    
                }, 1000);

                setInterval(function(){
                    readProblemList();
                }, 10000);


            });
        </script>
    </body>
</html>
